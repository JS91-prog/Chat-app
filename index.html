<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>Personal Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* GLOBAL & BACKGROUND */
        body { font-family: 'Poppins', sans-serif; height: 100vh; height: 100dvh; margin: 0; overflow: hidden; background-image: url('https://wallpaperaccess.com/full/8400089.jpg'); background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; }
        
        .glass-panel {
            position: relative;
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: flex;
            overflow: hidden;
            z-index: 1;
            max-width: 90%;
        }
        
        /* --- CLOCK STYLES --- */
        .login-widgets {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .clock {
            font-size: 64px;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 0 0 25px rgba(99, 102, 241, 0.6);
            line-height: 1;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        .date {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            font-weight: 400;
        }
        
        /* LOGIN MODIFIED */
        .glass-panel h1 {color: #ffffff; margin: 10px 0 30px 0; font-size: 24px;} 
        
        #login-screen input::placeholder {color: white;opacity: 1;}
        #login-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 350px; padding: 3rem 2.5rem; text-align: center; color: white; display: flex; flex-direction: column; gap: 15px; }
        #login-screen input { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 15px; border-radius: 30px; width: 100%; box-sizing: border-box; text-align: center; outline: none; font-size: 16px; }
        #login-screen button { padding: 15px; background: linear-gradient(135deg, #0083fe 0%, #00f2fe 100%); color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: 700; width: 100%; font-size: 16px; }
        #login-screen button:hover { background: linear-gradient(135deg, #00f2fe 0%, #0083fe 100%); transform: translateY(-2px); }
        
        /* CHAT INTERFACE */
        #chat-screen { display: none; width: 95%; height: 92vh; flex-direction: column; position: relative; }
        
        /* HEADER LAYOUT */
        .chat-header { 
            background: rgba(44, 62, 80, 0.4);  
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            z-index: 20;
            position: relative;
            height: 55px; 
        }

        /* Left Side */
        .header-left { 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: flex-start;
            cursor: pointer; 
        }
        
        .header-title { 
            font-weight: 600; 
            font-size: 16px; 
            line-height: 1.2;
            white-space: nowrap; 
        }

        #online-count { 
            font-size: 11px; 
            color: rgba(255,255,255,0.7); 
            font-weight: 400;
            margin-top: 2px;
        }

        /* Right Side */
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        /* CYLINDRICAL PILLS */
        .status-pill {
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .status-online { background: #22c55e; }     /* Green */
        .status-offline { background: #ef4444; }    /* Red */
        .status-connecting { background: #f59e0b; } /* Yellow/Orange */

        /* USER LIST DROPDOWN */
        #user-list-dropdown {
            display: none;
            position: absolute;
            top: 70px; 
            left: 20px; 
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            width: 220px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
        }
        #user-list-dropdown h4 { margin: 0 0 10px 0; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;}
        .user-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 14px; }
        .user-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }

        /* ICONS */
        .icon-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s; flex-shrink: 0; }
        .icon-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.05); }
        .icon-btn svg { width: 18px; height: 18px; fill: currentColor; display: block; }

        .action-btn { background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 42px; height: 42px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; color: #444; }
        .action-btn:hover { transform: scale(1.1); background: white; }
        .action-btn svg { width: 22px; height: 22px; fill: currentColor; display: block; }

        /* RECORDING UI */
        .record-btn { background: rgba(255, 255, 255, 0.9); }
        .recording { background: #ef4444 !important; animation: pulse-red 1s infinite; color: white !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        #recording-overlay {
            display: none; position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(239, 68, 68, 0.9); padding: 10px 20px; border-radius: 30px;
            color: white; font-weight: 600; font-size: 14px; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 100;
        }
        .rec-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* UPLOAD PROGRESS UI */
        #upload-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 150; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-box {
            background: white; width: 80%; max-width: 300px; padding: 20px; border-radius: 15px;
            text-align: center; color: #333;
        }
        .progress-track { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #6366f1; transition: width 0.3s; }

        /* MESSAGES */
        .chat-messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; scrollbar-width: thin; }
        .message { padding: 14px 22px; border-radius: 20px; max-width: 80%; word-wrap: break-word; position: relative; font-size: 14px; }
        .my-message { align-self: flex-end; background:#7204d3; color: #ffffff; border-bottom-right-radius: 4px; }
        .other-message { align-self: flex-start; background:#f5576c 100%; color: rgb(255, 255, 255); border-bottom-left-radius: 4px; }

        .system-message { 
            align-self: center; background: rgba(0,0,0,0.4); padding: 5px 15px; 
            border-radius: 16px; font-size: 12px; color: white; text-align: center; 
        }

        .msg-meta { font-size:10px; opacity:0.7; margin-top:5px; text-align: right; }

        /* TYPING INDICATOR */
        #typing-indicator {
            position: absolute; bottom: 80px; left: 25px;
            font-size: 12px; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 15px;
            display: none; animation: fadeIn 0.3s; pointer-events: none;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT AREA */
        .chat-input { display: flex; align-items: center; padding: 10px 15px; background: rgba(0, 0, 0, 0.3); gap: 8px; margin: 0 15px 15px 15px; border-radius: 30px; transition: opacity 0.3s; }
        .chat-input input[type="text"] { padding: 12px 20px; border: none; border-radius: 30px; flex: 1; outline: none; background: rgba(255,255,255,0.9); font-size: 16px; }

        /* VIDEO CALL OVERLAY */
        #call-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center; }
        .video-container { position: relative; width: 95%; max-width: 800px; aspect-ratio: 16/9; background: #111; border-radius: 20px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; bottom: 20px; right: 20px; width: 120px; height: 90px; background: #333; border-radius: 12px; border: 2px solid rgba(255,255,255,0.5); object-fit: cover; transform: scaleX(-1); }
        .call-controls { display: flex; gap: 20px; margin-top: 20px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-size: 20px; }
        .btn-end { background: #ef4444; }
    </style>
</head>
<body>

    <div id="upload-overlay">
        <div class="upload-box">
            <h3 style="margin:0;">Sending File...</h3>
            <p id="upload-filename" style="font-size:12px; color:#666; margin:5px 0;">image.png</p>
            <div class="progress-track">
                <div id="upload-bar" class="progress-fill"></div>
            </div>
            <div id="upload-percent" style="font-weight:bold; color:#6366f1;">0%</div>
        </div>
    </div>

    <div id="recording-overlay">
        <div class="rec-dot"></div>
        <span id="recording-time">Recording... 00:00</span>
    </div>

    <div id="call-overlay">
        <div class="video-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
            <div id="audio-placeholder" style="display:none; color:white; flex-direction:column; align-items:center;">
                <div style="width:80px; height:80px; background:#6366f1; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px;">üé§</div>
                <h3>Voice Call Active</h3>
            </div>
        </div>
        <div class="call-controls">
            <button class="call-btn btn-end" onclick="endCall(true)">
                <svg style="width:28px;height:28px;fill:currentColor" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
            </button>
        </div>
        <div style="color:white; margin-top:10px;" id="call-status">Connecting...</div>
    </div>

    <div id="login-screen" class="glass-panel">
        <div class="login-widgets">
            <div id="clock-display" class="clock">00:00</div>
            <div id="date-display" class="date">Loading Date...</div>
        </div>

        <h1>Personal Chat</h1>
        <input type="text" id="username" placeholder="Enter Name" onkeypress="if(event.key==='Enter') joinChat()">
        <button onclick="joinChat()">Join</button>
    </div>

    <div id="chat-screen" class="glass-panel">
        <div class="chat-header">
            <div class="header-left" onclick="toggleUserList()">
                <div class="header-title">Group Chat</div>
                <div id="online-count">0 Users Online ‚ñæ</div>
            </div>
             
            <div class="header-left">
                <span id="connection-state" class="status-pill status-connecting">CONNECTING...</span>
            </div>

            <div class="header-right">
                <button class="icon-btn" onclick="startCall('voice')" title="Voice Call">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2a15.11 15.11 0 0 1-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.33 8.5 5.14 8.5 3.9c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/></svg>
                </button>
                <button class="icon-btn" onclick="startCall('video')" title="Video Call">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
            </div>
        </div>

        <div id="user-list-dropdown">
            <h4>Online Users</h4>
            <div id="user-list-content">
                </div>
        </div>

        <div class="chat-messages" id="message-container"></div>
        
        <div id="typing-indicator">
            <span id="typing-text">Someone is typing...</span>
            <span class="rec-dot" style="display:inline-block; background:white; width:6px; height:6px; margin-left:5px;"></span>
        </div>

        <div class="chat-input" id="chat-input-bar">
            <input type="file" id="file-input" hidden onchange="handleFileUpload(this)">
            <button class="action-btn" onclick="document.getElementById('file-input').click()" title="Attach File">
                <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
            </button>
            <button id="record-btn" class="action-btn record-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button>
            
            <input type="text" id="message-input" placeholder="Message..." 
                   onkeypress="if(event.key==='Enter') sendMessage()"
                   oninput="handleTyping()">
            
            <button class="action-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24" style="margin-left: 3px;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io(); 
        let username = "", localStream, peerConnection, mediaRecorder;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let isVideoCall = true, audioChunks = [];
        let recStartTime, recInterval;
        const recordBtn = document.getElementById('record-btn');
        let typingTimeout;

        // --- CLOCK LOGIC (24H) ---
        function updateClock() {
            const now = new Date();
            // 24 Hour Format
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            const dateString = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            
            document.getElementById('clock-display').innerText = timeString;
            document.getElementById('date-display').innerText = dateString;
        }
        setInterval(updateClock, 1000);
        updateClock(); // Initial call
        // -------------------------

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Failed', err));
            });
        }

        // STATUS HANDLER
        function setOnlineState(status) {
            const el = document.getElementById('connection-state');
            const bar = document.getElementById('chat-input-bar');
            
            // Reset classes
            el.className = 'status-pill';
            
            if (status === 'online') {
                el.classList.add('status-online');
                el.innerText = "ONLINE";
                bar.style.opacity = "1"; bar.style.pointerEvents = "auto";
            } else if (status === 'offline') {
                el.classList.add('status-offline');
                el.innerText = "OFFLINE";
                bar.style.opacity = "0.5"; bar.style.pointerEvents = "none";
            } else {
                el.classList.add('status-connecting');
                el.innerText = "CONNECTING...";
            }
        }
        
        socket.on('connect', () => setOnlineState('online'));
        socket.on('disconnect', () => setOnlineState('offline'));

        function joinChat() {
            username = document.getElementById("username").value.trim() || "Guest";
            // Request Notification Permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            socket.emit("join_chat", { username: username });
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
        }

        function toggleUserList() {
            const list = document.getElementById('user-list-dropdown');
            list.style.display = (list.style.display === 'block') ? 'none' : 'block';
        }

        document.addEventListener('click', function(event) {
            const list = document.getElementById('user-list-dropdown');
            const headerLeft = document.querySelector('.header-left');
            if (list.style.display === 'block' && !list.contains(event.target) && !headerLeft.contains(event.target)) {
                list.style.display = 'none';
            }
        });

        socket.on('update_user_list', (data) => {
            document.getElementById('online-count').innerHTML = `${data.count} Users Online ‚ñæ`;
            const container = document.getElementById('user-list-content');
            container.innerHTML = '';
            data.users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `<div class="user-dot"></div><span>${user.name} ${user.name === username ? '(You)' : ''}</span>`;
                container.appendChild(div);
            });
        });

        function handleTyping() {
            socket.emit('typing');
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop_typing');
            }, 1000);
        }

        socket.on('display_typing', (data) => {
            const indicator = document.getElementById('typing-indicator');
            const text = document.getElementById('typing-text');
            text.innerText = `${data.username} is typing...`;
            indicator.style.display = 'block';
        });

        socket.on('hide_typing', () => {
            document.getElementById('typing-indicator').style.display = 'none';
        });

        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function appendMessage(data) {
            const container = document.getElementById("message-container");
            const div = document.createElement("div");
            
            if (data.type === 'system') {
                div.className = "system-message";
                div.innerText = data.content;
            } else {
                const isMe = data.author === username;
                div.className = `message ${isMe ? "my-message" : "other-message"}`;
                if (data.msgId) div.setAttribute('id', `msg-${data.msgId}`);

                let content = `<div>${data.content}</div>`;
                
                if (data.type === 'file') {
                    if (data.fileType && data.fileType.startsWith("image/")) content = `<img src="${data.content}" style="max-width:100%; border-radius:10px;">`;
                    else if (data.fileType && data.fileType.startsWith("audio/")) content = `<audio controls src="${data.content}" style="max-width:200px;"></audio>`;
                    else content = `<a href="${data.content}" download="${data.fileName || 'file'}" style="color:inherit">üìÅ ${data.fileName || 'File'}</a>`;
                }

                div.innerHTML = `${content}<div class="msg-meta"><span>${data.author} ‚Ä¢ ${data.time}</span></div>`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById("message-input");
            if (input.value.trim()) {
                const msgId = generateId();
                socket.emit("send_message", { 
                    author: username, 
                    type: "text", 
                    content: input.value, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    msgId: msgId
                });
                socket.emit('stop_typing');
                input.value = "";
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 50 * 1024 * 1024) { alert("File is too large (Max 50MB)"); input.value = ""; return; }

            const overlay = document.getElementById('upload-overlay');
            const bar = document.getElementById('upload-bar');
            const percent = document.getElementById('upload-percent');
            const nameDisplay = document.getElementById('upload-filename');
            
            overlay.style.display = "flex";
            nameDisplay.innerText = file.name;
            bar.style.width = "0%";
            percent.innerText = "0%";

            const reader = new FileReader();

            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const progress = (e.loaded / e.total) * 50; 
                    bar.style.width = progress + "%";
                    percent.innerText = Math.floor(progress) + "%";
                }
            };

            reader.onload = (e) => {
                bar.style.width = "75%";
                percent.innerText = "Sending...";
                const msgId = generateId();

                socket.emit("send_message", { 
                    author: username, 
                    type: "file", 
                    fileType: file.type, 
                    fileName: file.name, 
                    content: e.target.result, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    msgId: msgId
                }, () => {
                    bar.style.width = "100%";
                    percent.innerText = "Sent!";
                    setTimeout(() => {
                        overlay.style.display = "none";
                        input.value = "";
                    }, 500);
                });
            };
            reader.readAsDataURL(file);
        }

        // Updated Receive Message with Notifications
        socket.on("receive_message", (data) => {
            appendMessage(data);
            
            // Notification Logic: If hidden and not me
            if (document.visibilityState === 'hidden' && data.author !== username && data.type !== 'system') {
                if (Notification.permission === 'granted') {
                    const notif = new Notification(`New message from ${data.author}`, {
                        body: data.type === 'file' ? `Sent a ${data.fileType}` : data.content,
                        icon: 'icon-192.png' // Assumes icon exists
                    });
                    notif.onclick = () => {
                        window.focus();
                        notif.close();
                    };
                }
            }
        });

        function updateRecTimer() {
            const now = new Date().getTime();
            const diff = now - recStartTime;
            const seconds = Math.floor((diff / 1000) % 60);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            document.getElementById('recording-time').innerText = 
                `Recording... ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        const startRec = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    clearInterval(recInterval);
                    document.getElementById('recording-overlay').style.display = 'none';
                    recordBtn.classList.remove('recording');

                    const reader = new FileReader();
                    const msgId = generateId();
                    reader.onloadend = () => socket.emit("send_message", { author: username, type: "file", fileType: "audio/webm", fileName: "voice.webm", content: reader.result, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), msgId: msgId });
                    reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                
                recordBtn.classList.add('recording');
                document.getElementById('recording-overlay').style.display = 'flex';
                recStartTime = new Date().getTime();
                updateRecTimer();
                recInterval = setInterval(updateRecTimer, 1000);

            } catch (err) { alert("Mic Error: Use HTTPS."); }
        };
        const stopRec = () => { if (mediaRecorder && mediaRecorder.state !== "inactive") { mediaRecorder.stop(); } };
        
        recordBtn.addEventListener('mousedown', startRec);
        recordBtn.addEventListener('mouseup', stopRec);
        recordBtn.addEventListener('mouseleave', stopRec);
        recordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRec(); });
        recordBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRec(); });

        async function startCall(type) {
            isVideoCall = (type === 'video');
            updateCallUI(isVideoCall);
            document.getElementById('call-overlay').style.display = 'flex';
            document.getElementById('call-status').innerText = "Calling...";
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideoCall, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                createPC();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('call_user', { offer, caller: username, type });
            } catch (err) { endCall(true); alert("Camera/Mic Error: " + err.message); }
        }

        socket.on('call_made', async (data) => {
            if (!confirm(`Incoming ${data.type} call from ${data.caller}. Accept?`)) { socket.emit('end_call'); return; }
            isVideoCall = (data.type === 'video');
            updateCallUI(isVideoCall);
            document.getElementById('call-overlay').style.display = 'flex';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideoCall, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                createPC();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('make_answer', { answer, to: data.caller });
            } catch (err) { endCall(true); }
        });

        socket.on('answer_made', async data => { await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); document.getElementById('call-status').innerText = "Connected"; });
        socket.on('ice_candidate', async data => { if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); });
        socket.on('call_ended', () => endCall(false));

        function createPC() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            peerConnection.onicecandidate = e => { if (e.candidate) socket.emit('ice_candidate', { candidate: e.candidate }); };
            peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
        }
        function updateCallUI(isVideo) {
            document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
            document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
            document.getElementById('audio-placeholder').style.display = isVideo ? 'none' : 'flex';
        }
        function endCall(notify) {
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            document.getElementById('call-overlay').style.display = 'none';
            if (notify) socket.emit('end_call');
        }
    </script>
</body>
</html>